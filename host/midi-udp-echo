#!/usr/bin/env python3

from miditools.udpmidi import MidiServer

with MidiServer() as srv:
    print("midi-udp-echo: waiting for data on {}".format(srv))
    while(True):
        # get next message
        pkt, port = srv.recv()
        # some stats
        port_num = port.get_port_num()
        print(port_num, ": recv from", srv.get_peer_addr(), ":", pkt)
        lost_pkts = srv.get_lost_pkts()
        if lost_pkts:
            print(port_num, ": lost packets:", lost_pkts)
        # echo reply
        if pkt.is_sysex():
            port.send_sysex(pkt.get_sysex())
        else:
            port.send_msg(pkt.get_msg())
